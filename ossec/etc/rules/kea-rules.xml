<!-- Rogue DHCP Server Detection -->
<group name="kea_rogue_detection,">
  <rule id="130100" level="12">
    <decoded_as>kea-rogue-dhcp</decoded_as>
    <description>Rogue DHCP server detected: IP $(conflict_ip) with MAC $(conflict_mac)</description>
  </rule>
  
  <rule id="130101" level="10">
    <decoded_as>kea-dhcp4-lease</decoded_as>
    <field name="client_ip">^(0.0.0.0|169.254.|255.)</field>
    <description>Suspicious DHCP lease: Invalid IP $(client_ip) to MAC $(mac_address)</description>
  </rule>
</group>

<!-- DHCP Starvation Attacks -->
<group name="kea_starvation,">
  <rule id="130200" level="8">
    <decoded_as>kea-dhcp4-lease</decoded_as>
    <same_mac />
    <frequency>10</frequency>
    <timeframe>60</timeframe>
    <description>DHCP starvation attempt: Multiple leases to MAC $(mac_address)</description>
  </rule>
  
  <rule id="130201" level="7">
    <decoded_as>kea-dhcp4-lease-released</decoded_as>
    <same_mac />
    <frequency>15</frequency>
    <timeframe>120</timeframe>
    <description>Rapid DHCP release/request cycle: Possible starvation - MAC $(mac_address)</description>
  </rule>
</group>

<!-- Suspicious Lease Patterns -->
<group name="kea_suspicious_leases,">
  <rule id="130300" level="6">
    <decoded_as>kea-dhcp4-lease</decoded_as>
    <field name="lease_time">^(0|1)$</field>
    <description>Suspiciously short DHCP lease: $(lease_time) seconds to MAC $(mac_address)</description>
  </rule>
  
  <rule id="130301" level="7">
    <decoded_as>kea-dhcp4-lease</decoded_as>
    <field name="mac_address">^(00:00:00:00:00:00|FF:FF:FF:FF:FF:FF|01:00:5E:)</field>
    <description>Suspicious MAC address in DHCP lease: $(mac_address) -> $(client_ip)</description>
  </rule>
</group>

<!-- IPv6 Specific Security -->
<group name="kea_ipv6_security,">
  <rule id="130400" level="8">
    <decoded_as>kea-dhcp6-lease</decoded_as>
    <field name="lease_type">IA_NA</field>
    <same_duid />
    <frequency>5</frequency>
    <timeframe>300</timeframe>
    <description>Multiple IPv6 leases to same DUID: Possible SLAAC abuse - $(duid)</description>
  </rule>
  
  <rule id="130401" level="9">
    <decoded_as>kea-dhcp6-lease</decoded_as>
    <field name="duid">^00:00:00:00:00:00:00</field>
    <description>Suspicious DUID in IPv6 lease: $(duid) -> $(client_ip)</description>
  </rule>
</group>

<!-- High Availability Security -->
<group name="kea_ha_security,">
  <rule id="130500" level="10">
    <decoded_as>kea-ha</decoded_as>
    <field name="ha_event">FAILOVER</field>
    <field name="state">partner-down</field>
    <description>Kea HA failover: Partner $(partner) is down</description>
  </rule>
  
  <rule id="130501" level="8">
    <decoded_as>kea-ha</decoded_as>
    <field name="ha_event">STATE</field>
    <field name="state">partner-in-maintenance</field>
    <description>Kea HA partner in maintenance: $(partner)</description>
  </rule>
</group>

<!-- DHCP + DNS Correlation -->
<group name="kea_dns_correlation,">
  <rule id="130600" level="10">
    <if_sid>130100,130200</if_sid> <!-- Rogue/Starvation events -->
    <same_mac />
    <if_matched_sid>120100,120101</if_matched_sid> <!-- DNS tunneling -->
    <timeframe>600</timeframe>
    <description>Suspicious DHCP client $(mac_address) also showing DNS tunneling behavior</description>
  </rule>
  
  <rule id="130601" level="9">
    <if_sid>130300</if_sid> <!-- Suspicious lease -->
    <same_ip>client_ip</same_ip>
    <if_matched_sid>120300,120302</if_matched_sid> <!-- DNS reconnaissance -->
    <timeframe>300</timeframe>
    <description>Suspicious DHCP lease $(client_ip) performing DNS reconnaissance</description>
  </rule>
</group>

<!-- Rapid IP Changes -->
<group name="kea_ip_changes,">
  <rule id="130700" level="7">
    <decoded_as>kea-dhcp4-lease</decoded_as>
    <same_mac />
    <different_ip>client_ip</different_ip>
    <frequency>3</frequency>
    <timeframe>300</timeframe>
    <description>Rapid IP changes for MAC $(mac_address) - possible MAC spoofing</description>
  </rule>
</group>

<!-- DHCP Service Attacks -->
<group name="kea_service_attacks,">
  <rule id="130800" level="10">
    <decoded_as>kea-errors</decoded_as>
    <field name="error_type">PROCESS</field>
    <frequency>5</frequency>
    <timeframe>30</timeframe>
    <description>Kea service under attack: Multiple process failures</description>
  </rule>
  
  <rule id="130801" level="8">
    <decoded_as>kea-errors</decoded_as>
    <field name="error_type">PACKET</field>
    <same_src_ip />
    <frequency>20</frequency>
    <timeframe>60</timeframe>
    <description>DHCP packet flood from $(client_ip)</description>
  </rule>
</group>

<!-- DDNS Attack Detection -->
<group name="kea_ddns_attacks,">
  <rule id="131000" level="10">
    <decoded_as>kea-dns-update</decoded_as>
    <field name="hostname">(?i)(dc|domain-controller|dns|dhcp|router|firewall|gateway)\.</field>
    <description>Critical hostname DDNS update: $(hostname) -> $(ip_address)</description>
  </rule>
  
  <rule id="131001" level="8">
    <decoded_as>kea-dns-update</decoded_as>
    <same_src_ip />
    <frequency>10</frequency>
    <timeframe>60</timeframe>
    <description>DDNS update flood: Multiple updates from same client</description>
  </rule>
  
  <rule id="131002" level="9">
    <decoded_as>kea-dns-conflict</decoded_as>
    <description>DDNS conflict detected: $(hostname) IP change $(existing_ip) -> $(new_ip)</description>
  </rule>
  
  <rule id="131003" level="7">
    <decoded_as>kea-dns-update-failed</decoded_as>
    <same_src_ip />
    <frequency>5</frequency>
    <timeframe>120</timeframe>
    <description>DDNS update failures: Possible hostname enumeration - $(failure_reason)</description>
  </rule>
  
  <rule id="131004" level="8">
    <decoded_as>kea-dns-update</decoded_as>
    <field name="hostname">\.(duckdns|no-ip|dyn|changeip)\.</field>
    <description>Dynamic DNS hostname update: Possible C2 communication - $(hostname)</description>
  </rule>
</group>

<!-- Control Agent Security -->
<group name="kea_control_security,">
  <rule id="131100" level="12">
    <decoded_as>kea-control-config</decoded_as>
    <field name="config_action">CHANGED</field>
    <description>Kea configuration changed by $(username) via $(method)</description>
  </rule>
  
  <rule id="131101" level="10">
    <decoded_as>kea-control-lease</decoded_as>
    <field name="lease_action">DELETED</field>
    <description>Kea lease manually deleted: $(ip_address) by $(username)</description>
  </rule>
  
  <rule id="131102" level="11">
    <decoded_as>kea-control-lease</decoded_as>
    <field name="lease_action">ADDED</field>
    <description>Kea lease manually added: $(ip_address) by $(username)</description>
  </rule>
  
  <rule id="131103" level="8">
    <decoded_as>kea-control-auth</decoded_as>
    <field name="auth_action">FAILED</field>
    <same_username />
    <frequency>5</frequency>
    <timeframe>300</timeframe>
    <description>Control Agent brute force attempt: User $(username) from $(source_ip)</description>
  </rule>
  
  <rule id="131104" level="9">
    <decoded_as>kea-control-command</decoded_as>
    <field name="command">shutdown|reconfigure|libreload</field>
    <description>Critical Kea command executed: $(command) by $(username)</description>
  </rule>
</group>

<!-- After-Hours Activity -->
<group name="kea_after_hours,">
  <rule id="131200" level="7">
    <decoded_as>kea-control-config</decoded_as>
    <time>21:00-06:00</time>
    <weekday>sat,sun</weekday>
    <description>After-hours configuration change: $(username) on weekend</description>
  </rule>
  
  <rule id="131201" level="6">
    <decoded_as>kea-control-lease</decoded_as>
    <time>22:00-05:00</time>
    <description>After-hours lease manipulation: $(username) at night</description>
  </rule>
</group>

<!-- Cross-Service Correlation -->
<group name="kea_cross_correlation,">
  <rule id="131300" level="12">
    <if_sid>131100,131101,131102</if_sid> <!-- Control changes -->
    <same_username />
    <if_matched_sid>131000,131002</if_matched_sid> <!-- DDNS attacks -->
    <timeframe>600</timeframe>
    <description>Configuration change followed by suspicious DDNS activity: $(username)</description>
  </rule>
  
  <rule id="131301" level="11">
    <if_sid>131103</if_sid> <!-- Auth failures -->
    <same_source_ip />
    <if_matched_sid>110100</if_matched_sid> <!-- Firewall blocks -->
    <timeframe>300</timeframe>
    <description>Control Agent auth failures followed by firewall blocks: $(source_ip)</description>
  </rule>
</group>

<!-- Unauthorized User Detection -->
<group name="kea_unauthorized_users,">
  <rule id="131400" level="10">
    <decoded_as>kea-control-config</decoded_as>
    <field name="username">^(root|admin|administrator)$</field>
    <description>Privileged user configuration change: $(username)</description>
  </rule>
  
  <rule id="131401" level="12">
    <decoded_as>kea-control-config</decoded_as>
    <field name="username">^(unknown|test|default|guest)$</field>
    <description>Unauthorized user accessing Control Agent: $(username)</description>
  </rule>
</group>
